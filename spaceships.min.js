function inherits(a,b){a.super_=b;a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}function within(a,b,c){return a+c>=b&&a-c<=b}function CanvasItem(){this.y=this.x=0;this.img=null}CanvasItem.prototype={constructor:CanvasItem,update:function(){},destroyed:function(){},render:function(){context.drawImage(this.img,this.x,this.y)}};
function CanvasCollection(a,b){if(!(a.prototype instanceof CanvasItem))throw Error("BAD USER");this.item=a;this.items=[];this.max=b}
CanvasCollection.prototype={constructor:CanvasCollection,create:function(a){a=new this.item(a);this.items.length>=this.max&&this.items.shift();this.items.push(a);return a},update:function(){for(var a=0;a<this.items.length;a++)this.items[a].update()},gc:function(){this.items=this.items.filter(function(a){return!a.destroyed()})},render:function(){this.item.prototype instanceof Particle&&console.log(this.items);for(var a=0;a<this.items.length;a++)this.items[a].render()}};
function Star(){this.x=Math.random()*width|0;this.y=0;var a=document.createElement("canvas"),b=a.getContext("2d");a.height=a.width=10;b.beginPath();b.arc(2,2,2,0,2*Math.PI,!1);b.fillStyle="white";b.fill();b.closePath();this.img=a}inherits(Star,CanvasItem);Star.prototype.update=function(){this.y+=1};Star.prototype.destroyed=function(){return 0>this.x||this.x>=width||0>this.y||this.y>=height};
function Player(){this.x=Math.random()*width|0;this.y=Math.random()*height|0;this.h=this.w=48;this.dy=this.dx=0;this.turnSpeed=.001;this.thrust=.1;this.angle=0;this.exploded=!1;this.img=new Image;this.img.src="/img/player.png"}inherits(Player,CanvasItem);
Player.prototype.update=function(){keys[32]&&(thisPlayer.exploded?thisPlayer.reset():thisPlayer.fire());keys[90]&&thisPlayer.explode();keys[39]&&(this.angle+=-1*this.turnSpeed);keys[37]&&(this.angle+=1*this.turnSpeed);var a=this.angle/Math.PI*180;keys[38]&&(this.dx-=Math.sin(a)*this.thrust,this.dy-=Math.cos(a)*this.thrust);keys[40]&&(this.dx+=Math.sin(a)*this.thrust,this.dy+=Math.cos(a)*this.thrust);this.x+=this.dx;this.y+=this.dy;0>this.x?this.x=width:this.x>width&&(this.x=0);0>this.y?this.y=height:
this.y>height&&(this.y=0);this.dx*=.98;this.dy*=.98};Player.prototype.destroyed=function(){return this.exploded};Player.prototype.explode=function(){this.exploded||(this.exploded=!0,socket.emit("exploded",{name:name}),boom(this.x,this.y,this.dx,this.dy))};
Player.prototype.fire=function(){var a=180/Math.PI*(this.angle+.055),b=this.x+this.w/2*Math.cos(180/Math.PI*-(this.angle+.0275)),c=this.y+this.w/2*Math.sin(180/Math.PI*-(this.angle+.0275));playerBullets.create({x:b,y:c,dx:10*Math.sin(a),dy:10*Math.cos(a),c:"rgba(0,24,234,1)",r:7,decay:.04})};
function FBPlayer(a){this.x=a.x;this.y=a.y;this.angle=a.angle;this.name=a.name;this.h=55;this.w=50;this.connected=!0;this.exploded=!1;this.img=new Image;this.img.src="/img/enemy.png";this.lastUpdated=new Date}inherits(FBPlayer,CanvasItem);FBPlayer.prototype.update=function(){playerBullets.colliding(this.x,this.y)&&socket.emit("exploded",{name:this.name});this.firing&&!this.exploded&&this.fire()};FBPlayer.prototype.destroyed=function(){return!this.connected};
FBPlayer.prototype.render=Player.prototype.render=function(){this.exploded||(context.save(),context.translate(this.x,this.y),context.rotate(180/Math.PI*-(this.angle+.055)),context.drawImage(this.img,-this.w/2,-this.h/2),context.restore())};FBPlayer.prototype.reset=Player.prototype.reset=function(a){this.exploded&&(a||socket.emit("reset",{name:name}),this.constructor(a))};
FBPlayer.prototype.fire=function(){var a=180/Math.PI*(this.angle+.055),b=this.x+this.w/2*Math.cos(180/Math.PI*-(this.angle+.0275)),c=this.y+this.w/2*Math.sin(180/Math.PI*-(this.angle+.0275));particles.create({x:b,y:c,dx:10*Math.sin(a),dy:10*Math.cos(a),c:"rgba(287,3,24,1)",r:7,decay:.04})};
function Particle(a){this.x=a.x;this.y=a.y;var b=a.r||9*Math.random()+1|0,c=document.createElement("canvas"),d=c.getContext("2d");c.height=c.width=b;d.beginPath();d.rect(0,0,b,b);d.fillStyle=a.c;d.fill();d.closePath();this.img=c;this.dx=a.dx;this.dy=a.dy;this.created=Date.now();this.life=1;this.decay=a.decay||.01}inherits(Particle,CanvasItem);
Particle.prototype.update=function(){this.x+=this.dx;this.y+=this.dy;this.life-=this.decay;0>this.x?this.x=width:this.x>width&&(this.x=0);0>this.y?this.y=height:this.y>height&&(this.y=0)};Particle.prototype.render=function(){context.globalAlpha=this.life;context.drawImage(this.img,this.x,this.y)};Particle.prototype.destroyed=function(){return 0>this.life};
function boom(a,b,c,d){for(var g=randomColor(),f=0,h=16*Math.random()+32|0;f<h;f++){var e={x:a,y:b,c:g};e.dx=c+4*Math.random()-2;e.dy=d+4*Math.random()-2;particles.create(e)}}function randomColor(){var a=255*Math.random()|0,b=255*Math.random()|0,c=255*Math.random()|0;return"rgba("+a+","+b+","+c+",1)"}"use strict";
var name=("kittens"+Math.random()).replace(".",""),socket=io(document.location.href),canvas=document.getElementById("canvas"),height=canvas.height=700,width=canvas.width=1280,context=canvas.getContext("2d"),dtime=Date.now(),timing=1E3,centerHeight=height/2|0,centerWidth=width/2|0,stars=new CanvasCollection(Star),players=new CanvasCollection(FBPlayer),particles=new CanvasCollection(Particle,1E3),playerBullets=new CanvasCollection(Particle),thisPlayer=new Player;
playerBullets.colliding=function(a,b){for(var c=0;c<playerBullets.items.length;c++)if(within(playerBullets.items[c].x,a,24)&&within(playerBullets.items[c].y,b,24))return!0;return!1};var keys={};document.body.addEventListener("keydown",function(a){keys[a.keyCode]=!0});document.body.addEventListener("keyup",function(a){keys[a.keyCode]=!1});socket.emit("init",{x:thisPlayer.x,y:thisPlayer.y,dx:thisPlayer.dx,dy:thisPlayer.dy,angle:thisPlayer.angle,firing:!!keys[32],name:name});
function run(){var a=Date.now();if(a-dtime>timing)for(dtime=a,timing=1E3*Math.random(),a=0;5>a;a++)stars.create();stars.update();thisPlayer.update();particles.update();playerBullets.update();players.update();stars.gc();particles.gc();playerBullets.gc();players.gc();context.clearRect(0,0,width,height);stars.render();players.render();thisPlayer.render();particles.render();playerBullets.render();context.globalAlpha=1;requestAnimationFrame(run)}
setInterval(function(){socket.emit("heartbeat",{x:thisPlayer.x,y:thisPlayer.y,dx:thisPlayer.dx,dy:thisPlayer.dy,angle:thisPlayer.angle,firing:!!keys[32],name:name})},1E3/30);run();var fbPlayers={};socket.on("join",function(a){a.name!==name&&(fbPlayers[a.name]||(fbPlayers[a.name]=players.create(a)))});socket.on("exploded",function(a){if(a.name===name)thisPlayer.explode();else if(a=fbPlayers[a.name])boom(a.x,a.y,a.dx,a.dy),a.exploded=!0});socket.on("reset",function(a){fbPlayers[a.name].reset(a)});
socket.on("heartbeat",function(a){if(fbPlayers[a.name]){var b=fbPlayers[a.name];b.x=a.x;b.y=a.y;b.dx=a.dx;b.dy=a.dy;b.angle=a.angle;b.firing=a.firing}else fbPlayers[a.name]=players.create(a)});socket.on("child_removed",function(a){fbPlayers[a.name]=null});window.addEventListener("beforeunload",function(){socket.emit("leave",{name:name})},!1);